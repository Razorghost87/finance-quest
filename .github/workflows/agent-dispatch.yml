      - name: Open PR + label issue + enable auto-merge (safe-to-merge only)
        if: steps.find.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = Number("${{ steps.find.outputs.number }}");
            const head = process.env.BRANCH;
            const base = "main";

            // Check if the issue has safe-to-merge label
            const issue = await github.rest.issues.get({ owner, repo, issue_number });
            const issueLabels = (issue.data.labels || []).map(l => (typeof l === "string" ? l : l.name));
            const isSafeToMerge = issueLabels.includes("safe-to-merge");

            // Create PR
            const pr = await github.rest.pulls.create({
              owner,
              repo,
              title: `Agent PR: issue #${issue_number}`,
              head,
              base,
              body: `Automated PR for issue #${issue_number}.\nRun artifacts: runs/${process.env.RUN_ID}/`,
            });

            // Label the issue to reflect PR open
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number,
              labels: ["agent:pr-open"],
            });

            // Optional: label the PR for visibility
            // (only works if these labels exist as repo labels)
            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pr.data.number,
                labels: ["risk:low"].concat(isSafeToMerge ? ["safe-to-merge"] : []),
              });
            } catch (e) {
              core.info("PR labeling skipped (labels may not exist or insufficient perms).");
            }

            // Enable auto-merge ONLY if issue is safe-to-merge
            if (isSafeToMerge) {
              core.info("safe-to-merge detected on issue — enabling PR auto-merge.");

              // Enable PR auto-merge via GraphQL
              const mutation = `
                mutation EnableAutoMerge($pullRequestId: ID!) {
                  enablePullRequestAutoMerge(input: { pullRequestId: $pullRequestId, mergeMethod: MERGE }) {
                    pullRequest {
                      number
                      autoMergeRequest { enabledAt }
                    }
                  }
                }
              `;

              await github.graphql(mutation, { pullRequestId: pr.data.node_id });
            } else {
              core.info("Issue is NOT safe-to-merge — auto-merge not enabled.");
            }

            core.info(`Created PR #${pr.data.number}: ${pr.data.html_url}`);
