name: Agent Dispatcher

on:
  schedule:
    - cron: "*/5 * * * *" # Every 5 minutes (24/7)

# Prevent overlapping runs (important when running frequently)
concurrency:
  group: agent-dispatch
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  dispatch:
    runs-on: ubuntu-latest

    steps:
      - name: Find oldest ready issue
        id: find
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            const res = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              labels: "agent:ready",
              per_page: 10,
              sort: "created",
              direction: "asc",
            });

            const issue = res.data.find(i => !i.pull_request);
            if (!issue) {
              core.setOutput("found", "false");
              return;
            }

            core.setOutput("found", "true");
            core.setOutput("number", String(issue.number));
            core.setOutput("title", issue.title);

      - name: Checkout
        if: steps.find.outputs.found == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claim issue (swap labels)
        if: steps.find.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = Number("${{ steps.find.outputs.number }}");

            await github.rest.issues.removeLabel({ owner, repo, issue_number, name: "agent:ready" })
              .catch(() => {});

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number,
              labels: ["agent:in-progress"],
            });

      - name: Create branch + artifacts + minimal safe change
        if: steps.find.outputs.found == 'true'
        env:
          ISSUE_NUMBER: ${{ steps.find.outputs.number }}
          ISSUE_TITLE: ${{ steps.find.outputs.title }}
        run: |
          set -euo pipefail

          SLUG=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g' | sed -E 's/^-+|-+$//g' | cut -c1-40)
          BRANCH="agent/${ISSUE_NUMBER}-${SLUG}"
          RUN_ID="run-${GITHUB_RUN_ID}-${GITHUB_RUN_NUMBER}"

          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

          git checkout -b "$BRANCH"

          mkdir -p "runs/$RUN_ID/evidence" "runs/$RUN_ID/logs"
          cat > "runs/$RUN_ID/proposal.md" <<EOF
          Bootstrap agent run for issue #$ISSUE_NUMBER
          Safe-mode proof: docs-only update + run artifacts.
          EOF

          cat > "runs/$RUN_ID/tasks.md" <<EOF
          - [x] Claim issue
          - [x] Create run artifacts
          - [x] Append line to docs/DEV_AUTOMATION.md
          - [x] Open PR
          EOF

          cat > "runs/$RUN_ID/context.json" <<EOF
          {"issue": $ISSUE_NUMBER, "timestamp_utc": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')", "mode": "safe-bootstrap"}
          EOF

          mkdir -p docs
          touch docs/DEV_AUTOMATION.md
          echo "" >> docs/DEV_AUTOMATION.md
          echo "Automation heartbeat: $(date -u +'%Y-%m-%dT%H:%M:%SZ') (issue #$ISSUE_NUMBER)" >> docs/DEV_AUTOMATION.md

          git config user.name "North Agent"
          git config user.email "agent@north.finance"
          git add runs docs/DEV_AUTOMATION.md
          git commit -m "agent: issue #$ISSUE_NUMBER safe-mode proof"
          git push -u origin "$BRANCH"

      - name: Open PR + label issue + enable auto-merge (safe-to-merge only)
        if: steps.find.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = Number("${{ steps.find.outputs.number }}");
            const head = process.env.BRANCH;
            const base = "main";

            // Read issue labels (gate auto-merge)
            const issue = await github.rest.issues.get({ owner, repo, issue_number });
            const issueLabels = (issue.data.labels || []).map(l => (typeof l === "string" ? l : l.name));
            const isSafeToMerge = issueLabels.includes("safe-to-merge");

            // Create PR
            const pr = await github.rest.pulls.create({
              owner,
              repo,
              title: `Agent PR: issue #${issue_number}`,
              head,
              base,
              body: `Automated PR for issue #${issue_number}.\n\nCloses #${issue_number}\n\nRun artifacts: runs/${process.env.RUN_ID}/`,
            });

            // Label issue: PR opened
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number,
              labels: ["agent:pr-open"],
            });

            // Enable auto-merge only for safe-to-merge
            if (isSafeToMerge) {
              const mutation = `
                mutation EnableAutoMerge($pullRequestId: ID!) {
                  enablePullRequestAutoMerge(input: { pullRequestId: $pullRequestId, mergeMethod: MERGE }) {
                    pullRequest { number }
                  }
                }
              `;
              await github.graphql(mutation, { pullRequestId: pr.data.node_id });
              core.info("Auto-merge enabled (safe-to-merge).");
            } else {
              core.info("Auto-merge not enabled (missing safe-to-merge).");
            }

            core.info(\`Created PR #\${pr.data.number}: \${pr.data.html_url}\`);
