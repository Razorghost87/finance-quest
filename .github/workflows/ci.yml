name: CI Gates

on:
  pull_request:
    branches: [main, master]

jobs:
  policy-guard:
    name: Policy Guard (Forbidden Paths)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Forbidden Path Changes
        run: |
          FORBIDDEN_PATHS=(
            "supabase/functions/"
            "supabase/migrations/"
            "PIPELINE_STANDARDIZATION.sql"
            "COMPLETE_SCHEMA_INIT.sql"
            "lib/auth/"
            "lib/guest_token.ts"
            "package.json"
            "package-lock.json"
            ".env"
          )

          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "Changed files: $CHANGED_FILES"

          for file in $CHANGED_FILES; do
            for forbidden in "${FORBIDDEN_PATHS[@]}"; do
              if [[ $file == $forbidden* ]]; then
                echo "❌ ERROR: Modification of forbidden path detected: $file"
                exit 1
              fi
            done
          done
          echo "✅ No forbidden paths modified."

  build-and-test:
    name: Build and Verify
    runs-on: ubuntu-latest
    needs: policy-guard
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Type Check (if script exists)
        run: npm run typecheck || echo "typecheck script not found, skipping"

      - name: Lint (if script exists)
        run: npm run lint || echo "lint script not found, skipping"

      - name: Test (if script exists)
        run: npm test || echo "test script not found, skipping"
